# Wirebot

A plugin based multi-purpose slackbot for development pipeline and infrastructure monitoring.


## Configuration

Make sure the `config.py` reflects configuration parameters from your instance of slack and other services. Many of these configuration values are sensitive, so they come from the process environment variables. A comprehensive list of environment variables required for the system to work (including those used by various plugins) is indicated in the `.env.example` file.

Should you wish to disable some of the plugins, remove them from the list of plugins in `app.py`.

The configuration of individual plugins is described in their relevant sections in the section on plugins. A "hello world" plugin is provided as a demo/sanity check for the application, which doesn't depend on any external configuration parameters. To run the application with just this plugin, comment out or remove all the plugins except `HelloPlugin` defined in the list of plugins in `app.py` and run the app.


## Setup and Running

This is a python3 project tested on python 3.11, so any versions newer than that should work too.

```bash
# clone the project
git clone https://github.com/ajmalsiddiqui/wirebot

cd wirebot

# Create a new virtualenv
virtualenv -p python3 .venv

# Activate the virtualenv
source .venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Run the project!
python app.py
```

## Usage

All interaction happens via mentioning @wirebot in a slack message. All plugins are notified of this message, and they can use it to decide if/how they want to respond. Messaging, "@wirebot hello" in a channel is a quick ping check to ensure that the slack parts are correctly wired up. Details about each plugin can be found in it's respective section in this README.


## Notes on Deployment

In the context of an application like this, it is not uncommon for various plugins to spawn their own web servers to act as endpoints for webhook events from 3rd parties. The ports used by such plugins are indicated and configurable in config.py. Thus, when this application is deployed, the network firewall should allow access to all these ports in addition to the port used by the slack webhook server.


## Supplied Plugins

The following example 3rd party integrations are provided with the project.

### Statuscake

The statuscake.io integration allows the slackbot to query the uptime status and immediate history of the site being monitored via a statuscake check, which is presented as an autogenerated graph. The statuscake webhook server additionally allows the bot to notify on slack if the site ever goes down. To invoke the uptime checks, send a message mentioning wirebot along with the keyword "uptime" included somewhere in the message.

In order to configure this plugin, a statuscake check must already exist, and the webhook URL of the statuscake server (wherein the port is configured in `config.py` or via the environment) should be included as an alert notification target in statuscake. Finally, you also need a Statuscake API key, which should be a part of your configuration/environment.

### GitHub

The integration with GitHub allows one to query the most recent pushes to the repository associated with the website. This can be invoked by mentioning wirebot in a message and including the keyword "github". Currently, the bot also has a webhook integration that allows it to notify slack when a new push happens to any branch.

In order to configure this, a GitHub PAT (Personal Access Token) associated with the target repository needs to be supplied via the configuration, and the webhook URL of the GitHub server (wherein the port is configured via `config.py` or the environment) needs to be added to the settings of the GitHub repository.

### Google Analytics

The google analytics plugin currently implements one sample fixed query, which shows the distribution of users based on country. This is presented as a pie chart. This functionality is invoked by mentioning wirebot and including the keyword "analytics".

The configuration of this is a little more involved. A set of authentication credentials with access to the Google Analytics 4 project associated with the website must be obtained from the GCP (Google Cloud Platform) console. This comes as a JSON file that must be kept secret (it contains sensitive credentials). The path to this file should be set as the value of the `GOOGLE_APPLICATION_CREDENTIALS` environment variable. Finally, the Google Analytics 4 property ID needs to be configured in `config.py` or via environment variables.


## Writing Your Own Plugin

This project comes with a simple interface that allows you to write your own plugins for the chatbot. All you have to do is implement a class that subclasses the `plugin.Plugin` abstract class, and implement required methods. There are three methods to implement:

1. `setup`: This is called when setting up all the plugins, and so is a good place setup infrastructure that the plugin will use. Typically, this is used to spawn threads that run webhook servers.
2. `teardown`: Teardown infrastructure used by plugins during shutdown.
3. `handle_mention`: This is a callback that is invoked every time someone mentions wirebot on slack. The details of the mention event are provided in the `event` parameter, along with a `slack_client`. You can use the event to judge whether your plugin should respond to this event in some way, and, if so, it can use the slack client to leverage the full power of the slack API.

It is strongly recommend to call the superclass constructor in the `__init__` method of each plugin, which requires that you supply a slack client to the plugin. This is useful for interactions initiated by the plugin itself in response to e.g. webhook events. The slack client is then accessible by the plugin during all of it's methods.

Finally, modify the list of plugins in `app.py` to include your plugin. There is a slack client accessible in this context that you can supply as an init arg to your plugin as well. That's all it takes!
